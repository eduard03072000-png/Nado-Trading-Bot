=== ИНСТРУКЦИЯ ПО ИНТЕГРАЦИИ НОВОЙ СИСТЕМЫ ИСТОРИИ ===

1. ДОБАВИТЬ ИМПОРТЫ В telegram_trading_bot.py (в начале файла):

```python
from trade_history_manager import TradeHistoryManager
from history_handlers import show_history_menu, show_period_summary, show_period_details
```

2. СОЗДАТЬ ЭКЗЕМПЛЯР МЕНЕДЖЕРА ИСТОРИИ (после создания dashboard):

```python
# После строки: dashboard = TradingDashboard(...)
history_manager = TradeHistoryManager('trade_history.json')
```

3. ЗАМЕНИТЬ ФУНКЦИЮ show_history НА:

```python
async def show_history(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Показать меню выбора периода"""
    await show_history_menu(update, context, history_manager)
```

4. ДОБАВИТЬ НОВЫЕ CALLBACK HANDLERS (в application.add_handler):

```python
# История - периоды
application.add_handler(CallbackQueryHandler(
    lambda u, c: show_period_summary(u, c, history_manager, u.callback_query.data.split('_')[2]),
    pattern=r'^hist_period_'
))

# История - детали
async def history_details_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    parts = update.callback_query.data.split('_')
    period = parts[2]
    page = int(parts[3]) if len(parts) > 3 else 0
    await show_period_details(update, context, history_manager, period, page)

application.add_handler(CallbackQueryHandler(history_details_handler, pattern=r'^hist_details_'))
```

5. ЗАПИСЫВАТЬ ИСТОРИЮ ПРИ ЗАКРЫТИИ ПОЗИЦИЙ:

В функции close_position_handler (или где закрывается позиция):

```python
# После успешного закрытия позиции
if result:
    # Получаем данные позиции
    position = ...  # твоя позиция
    
    # Добавляем в историю
    history_manager.add_trade(
        symbol=position['symbol'],
        product_id=position['product_id'],
        side=position['side'],
        entry_price=entry_price,  # из positions_data.json
        exit_price=exit_price,  # текущая цена
        size=base_size,  # БЕЗ плеча!
        leverage=dashboard.leverage,
        entry_fee=entry_fee,  # рассчитать как notional * 0.0001
        exit_fee=exit_fee  # рассчитать как notional * 0.0001
    )
```

6. ПРИМЕР РАСЧЁТА КОМИССИЙ:

```python
# Комиссия входа
entry_notional = entry_price * position_size_with_leverage
entry_fee = entry_notional * 0.0001  # 0.01% maker fee

# Комиссия выхода
exit_notional = exit_price * position_size_with_leverage  
exit_fee = exit_notional * 0.0001  # 0.01% maker fee
```

=== ПРЕИМУЩЕСТВА НОВОЙ СИСТЕМЫ ===

✅ Правильный расчёт P&L с учётом плеча
✅ Вычет комиссий из net P&L
✅ ROI% от вложенного капитала (без плеча)
✅ Периоды: Сегодня, Вчера, Неделя, Месяц, Всё время
✅ Детальный просмотр сделок с пагинацией (по 5 на странице)
✅ Статистика: Win Rate, Avg P&L, Best/Worst, Объём, Комиссии
✅ Сохранение в JSON файл

=== КАК ИСПОЛЬЗОВАТЬ ===

Пользователь:
1. Нажимает "История"
2. Выбирает период (Сегодня / Вчера / Неделя / Месяц / Всё)
3. Видит сводку по периоду
4. Может нажать "Детали" для просмотра каждой сделки
5. Пагинация если сделок > 5
